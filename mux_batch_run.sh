#!/bin/bash
source /opt/ros/humble/setup.bash
source install/setup.bash

# ==========================================
# [설정] 실험 파라미터
# ==========================================

# 1. Mux Weight
mux_params=(
    "1.62 1.48 0.92 1.21 0.48 0.42"
"1.58 1.45 0.89 1.18 0.47 0.41"
"1.67 1.52 0.95 1.25 0.50 0.44"
"1.60 1.50 0.90 1.23 0.46 0.43"
"1.71 1.55 0.93 1.28 0.49 0.45"
"1.55 1.42 0.87 1.15 0.45 0.40"
"1.64 1.47 0.91 1.20 0.48 0.42"
"1.68 1.51 0.94 1.26 0.50 0.44"
"1.59 1.44 0.88 1.17 0.46 0.41"
"1.73 1.58 0.97 1.30 0.52 0.46"
"1.57 1.43 0.89 1.16 0.46 0.41"
"1.66 1.48 0.92 1.22 0.49 0.43"
"1.70 1.54 0.95 1.27 0.51 0.45"
"1.63 1.46 0.90 1.19 0.47 0.42"
"1.75 1.60 0.98 1.32 0.53 0.47"
"1.61 1.49 0.91 1.21 0.48 0.43"
"1.69 1.53 0.94 1.26 0.50 0.44"
"1.74 1.59 0.97 1.31 0.52 0.46"
"1.56 1.41 0.86 1.14 0.44 0.40"
"1.72 1.57 0.96 1.29 0.51 0.45"
"1.65 1.47 0.90 1.20 0.47 0.42"
"1.78 1.63 1.00 1.33 0.54 0.48"
"1.52 1.39 0.85 1.12 0.43 0.39"
"1.80 1.65 1.02 1.35 0.55 0.49"
"1.59 1.45 0.89 1.18 0.46 0.41"
"1.67 1.51 0.93 1.24 0.49 0.43"
"1.76 1.61 0.99 1.34 0.53 0.47"
"1.55 1.40 0.86 1.13 0.44 0.40"
"1.71 1.56 0.95 1.28 0.50 0.45"
"1.62 1.48 0.90 1.21 0.47 0.42"

"0.77 2.31 1.40 2.33 2.68 0.55"
"1.84 1.56 0.79 1.18 1.19 0.34"
"2.56 1.21 0.92 1.44 1.73 0.43"
"1.39 2.74 1.62 2.48 2.88 0.50"
"0.63 1.88 1.28 2.56 2.99 0.58"
"2.91 1.32 0.66 1.12 1.01 0.30"
"1.58 2.05 1.75 2.61 2.83 0.49"
"2.03 1.14 0.82 1.53 1.92 0.46"
"0.98 2.48 1.56 2.40 2.62 0.52"
"1.62 1.51 1.05 1.42 1.67 0.41"
"2.70 1.83 0.73 1.15 1.09 0.33"
"0.89 2.13 1.77 2.79 3.14 0.59"
"2.17 1.69 0.94 1.24 1.15 0.35"
"1.54 2.22 1.33 2.17 2.44 0.47"
"0.71 1.96 1.49 2.63 2.87 0.57"
"2.81 1.37 0.58 1.09 1.03 0.29"
"1.41 2.66 1.70 2.30 2.59 0.51"
"2.13 1.45 0.91 1.47 1.84 0.44"
"0.82 2.32 1.64 2.52 2.74 0.54"
"1.88 1.74 1.03 1.33 1.53 0.42"
"2.98 1.08 0.79 1.20 1.41 0.40"
"1.49 2.57 1.92 2.77 3.09 0.60"
"0.65 1.79 1.21 2.41 2.80 0.56"
"2.28 1.51 0.83 1.10 1.12 0.30"
"1.92 2.06 1.40 2.29 2.63 0.50"
"0.75 2.44 1.74 2.60 2.89 0.58"
"2.67 1.66 0.97 1.52 1.88 0.46"
"1.37 1.98 1.12 1.87 2.21 0.45"
"2.50 1.24 0.72 1.19 1.25 0.33"
"0.96 2.17 1.58 2.35 2.59 0.53"

"1.73 1.84 0.88 1.26 1.41 0.39"
"2.92 1.42 1.04 1.58 1.77 0.47"
"1.12 2.38 1.66 2.44 2.80 0.54"
"0.69 1.53 1.28 2.57 3.01 0.59"
"2.35 1.75 0.73 1.11 1.10 0.31"
"1.85 2.12 1.50 2.33 2.67 0.52"
"0.87 2.58 1.81 2.71 2.91 0.57"
"1.52 1.64 0.95 1.29 1.36 0.38"
"2.78 1.33 0.84 1.41 1.69 0.44"
"1.44 2.51 1.72 2.55 2.78 0.55"
"0.92 1.99 1.40 2.22 2.49 0.47"
"2.64 1.57 0.69 1.09 1.08 0.30"
"1.39 1.93 1.17 1.74 2.05 0.43"
"0.74 2.30 1.61 2.48 2.72 0.56"
"2.41 1.48 0.79 1.28 1.36 0.37"
"1.95 2.16 1.32 2.09 2.38 0.50"
"0.83 2.42 1.68 2.58 2.83 0.58"
"1.61 1.59 0.92 1.23 1.29 0.36"
"2.87 1.64 0.73 1.32 1.45 0.42"
"1.19 2.19 1.58 2.36 2.66 0.53"
"0.78 1.69 1.05 2.18 2.56 0.49"
"2.53 1.38 0.62 1.16 1.15 0.32"
"1.47 2.40 1.80 2.62 2.89 0.57"
"0.64 2.01 1.32 2.48 2.73 0.55"
"2.71 1.55 0.90 1.47 1.82 0.45"
"1.33 1.86 1.14 1.81 2.11 0.44"
"2.95 1.10 0.68 1.22 1.39 0.40"
"1.56 2.52 1.93 2.79 3.10 0.59"
"0.72 1.77 1.18 2.29 2.64 0.51"
"2.18 1.47 0.75 1.15 1.17 0.33"

"1.99 2.08 1.44 2.25 2.59 0.52"
"0.86 2.61 1.72 2.69 2.94 0.58"
"2.76 1.34 0.86 1.39 1.67 0.44"
"1.42 2.33 1.54 2.41 2.72 0.55"
"0.93 2.02 1.36 2.20 2.46 0.48"
"2.62 1.59 0.71 1.12 1.09 0.31"
"1.37 1.91 1.19 1.78 2.09 0.44"
"0.79 2.36 1.63 2.53 2.77 0.57"
"2.39 1.50 0.82 1.26 1.34 0.37"
"1.93 2.11 1.38 2.15 2.41 0.51"
"0.81 2.47 1.66 2.63 2.86 0.59"
"1.59 1.62 0.94 1.26 1.31 0.37"
"2.85 1.63 0.75 1.31 1.43 0.41"
"1.21 2.25 1.60 2.32 2.63 0.52"
"0.70 1.71 1.08 2.19 2.54 0.50"
"2.49 1.35 0.64 1.18 1.17 0.33"
"1.46 2.38 1.82 2.58 2.87 0.58"
"0.67 2.03 1.30 2.43 2.70 0.56"
"2.73 1.53 0.88 1.45 1.80 0.46"
"1.35 1.84 1.16 1.83 2.14 0.45"
"2.93 1.12 0.70 1.23 1.36 0.39"
"1.57 2.54 1.95 2.77 3.12 0.60"
"0.73 1.79 1.20 2.27 2.62 0.51"
"2.20 1.49 0.77 1.17 1.19 0.34"
"1.96 2.14 1.42 2.21 2.49 0.53"
"0.89 2.58 1.75 2.66 2.90 0.58"
"2.80 1.32 0.84 1.37 1.65 0.43"
"1.41 2.31 1.57 2.44 2.74 0.56"
"0.94 2.05 1.38 2.23 2.50 0.49"
"2.59 1.61 0.72 1.10 1.11 0.32"

"1.38 1.89 1.22 1.86 2.17 0.45"
"0.80 2.40 1.65 2.56 2.79 0.57"
"2.44 1.46 0.82 1.25 1.33 0.36"
"1.91 2.10 1.36 2.13 2.47 0.52"
"0.84 2.50 1.70 2.61 2.85 0.58"
"1.63 1.65 0.96 1.28 1.33 0.38"
"2.88 1.62 0.76 1.30 1.44 0.42"
"1.23 2.27 1.61 2.34 2.65 0.52"
"0.71 1.73 1.09 2.20 2.55 0.50"
"2.52 1.36 0.65 1.19 1.18 0.33"
"1.48 2.41 1.83 2.59 2.88 0.58"
"0.66 2.04 1.31 2.44 2.71 0.56"
"2.75 1.54 0.89 1.46 1.81 0.46"
"1.36 1.85 1.17 1.84 2.15 0.45"
"2.94 1.11 0.69 1.22 1.37 0.39"
"1.58 2.55 1.94 2.78 3.11 0.59"
"0.74 1.80 1.21 2.28 2.63 0.52"
"2.23 1.50 0.78 1.18 1.20 0.34"
"1.98 2.17 1.43 2.22 2.50 0.53"
"0.90 2.59 1.76 2.67 2.91 0.59"
"2.79 1.31 0.83 1.36 1.64 0.43"
"1.43 2.30 1.56 2.43 2.73 0.56"
"0.95 2.06 1.39 2.24 2.51 0.49"
"2.61 1.60 0.73 1.11 1.12 0.32"
"1.40 1.88 1.21 1.87 2.19 0.45"
"0.82 2.41 1.66 2.55 2.78 0.56"
"2.47 1.47 0.83 1.26 1.34 0.37"
"1.92 2.11 1.37 2.14 2.48 0.52"
"0.87 2.51 1.71 2.62 2.86 0.58"
"1.60 1.63 0.93 1.24 1.30 0.37"

"2.90 1.60 0.74 1.29 1.42 0.41"
"1.26 2.28 1.63 2.35 2.66 0.53"
"0.73 1.74 1.10 2.22 2.57 0.51"
"2.55 1.37 0.66 1.21 1.19 0.33"
"1.50 2.43 1.84 2.60 2.89 0.58"
"0.68 2.06 1.32 2.46 2.72 0.56"
"2.76 1.55 0.90 1.47 1.82 0.46"
"1.34 1.86 1.18 1.85 2.16 0.45"
"2.96 1.13 0.71 1.24 1.38 0.40"
"1.59 2.56 1.96 2.79 3.12 0.59"
"0.76 1.82 1.22 2.29 2.64 0.52"
"2.25 1.51 0.79 1.19 1.21 0.34"
"1.97 2.15 1.41 2.20 2.48 0.53"
"0.88 2.53 1.72 2.63 2.87 0.58"
"2.82 1.33 0.85 1.38 1.66 0.43"
"1.45 2.32 1.58 2.45 2.75 0.56"
"0.96 2.07 1.40 2.25 2.52 0.49"
"2.63 1.63 0.74 1.12 1.13 0.32"
"1.41 1.89 1.23 1.88 2.20 0.45"
"0.83 2.43 1.67 2.57 2.79 0.56"
"2.49 1.48 0.84 1.27 1.35 0.37"
"1.94 2.12 1.39 2.16 2.49 0.52"
"0.89 2.55 1.73 2.64 2.88 0.59"
"2.84 1.35 0.86 1.39 1.68 0.44"
"1.47 2.34 1.59 2.47 2.76 0.57"
"0.97 2.09 1.41 2.26 2.53 0.49"
"2.65 1.64 0.75 1.13 1.14 0.32"
"1.43 1.91 1.24 1.90 2.22 0.45"
"0.85 2.45 1.69 2.58 2.81 0.57"
"2.51 1.49 0.85 1.28 1.36 0.38"

"2.72 1.44 0.82 1.34 1.58 0.41"
"1.32 2.18 1.52 2.28 2.61 0.54"
"0.79 2.01 1.36 2.39 2.70 0.55"
"2.45 1.57 0.93 1.51 1.77 0.47"
"1.53 2.55 1.88 2.73 3.05 0.60"
"0.72 1.77 1.17 2.20 2.48 0.50"
"2.83 1.28 0.90 1.43 1.63 0.42"
"1.38 2.40 1.64 2.50 2.78 0.57"
"0.91 2.12 1.43 2.33 2.59 0.53"
"2.55 1.66 0.77 1.19 1.26 0.35"
"1.44 1.95 1.27 1.93 2.26 0.46"
"0.87 2.62 1.78 2.71 2.90 0.58"
"2.94 1.31 0.88 1.41 1.70 0.44"
"1.48 2.37 1.61 2.46 2.74 0.56"
"0.95 2.05 1.38 2.29 2.55 0.54"
"2.68 1.54 0.83 1.25 1.39 0.36"
"1.52 2.11 1.46 2.14 2.43 0.50"
"0.93 2.51 1.60 2.42 2.74 0.57"
"2.41 1.42 0.79 1.17 1.30 0.34"
"1.36 2.33 1.57 2.44 2.71 0.55"
"0.89 2.14 1.44 2.30 2.61 0.52"
"2.61 1.60 0.72 1.14 1.18 0.32"
"1.47 2.00 1.32 2.01 2.35 0.48"
"0.83 2.59 1.74 2.67 2.86 0.59"
"2.77 1.25 1.05 1.57 1.84 0.45"
"1.58 2.49 1.70 2.57 2.82 0.58"
"0.90 2.22 1.51 2.39 2.69 0.55"
"2.33 1.53 0.81 1.23 1.36 0.38"
"1.40 2.28 1.55 2.41 2.70 0.56"
"0.88 2.19 1.49 2.35 2.66 0.54"

"2.81 1.47 0.91 1.49 1.76 0.46"
"1.62 2.34 1.63 2.40 2.74 0.57"
"0.77 1.95 1.32 2.26 2.57 0.52"
"2.58 1.29 0.73 1.22 1.41 0.37"
"1.41 2.18 1.44 2.20 2.49 0.53"
"0.92 2.45 1.68 2.61 2.88 0.58"
"2.38 1.56 0.84 1.26 1.33 0.36"
"1.30 2.04 1.28 2.04 2.36 0.48"
"0.86 2.55 1.76 2.69 2.91 0.59"
"2.95 1.34 0.89 1.42 1.67 0.43"
"1.54 2.29 1.55 2.42 2.71 0.56"
"0.99 2.18 1.47 2.33 2.63 0.54"
"2.63 1.64 0.75 1.11 1.16 0.32"
"1.48 2.02 1.35 2.06 2.38 0.49"
"0.90 2.51 1.72 2.61 2.87 0.58"
"2.44 1.41 0.78 1.18 1.28 0.35"
"1.29 2.31 1.57 2.40 2.69 0.55"
"0.83 2.11 1.43 2.29 2.60 0.53"
"2.52 1.58 0.82 1.24 1.37 0.38"
"1.36 1.94 1.26 1.98 2.31 0.47"
"0.91 2.61 1.77 2.73 2.92 0.59"
"2.70 1.27 0.69 1.09 1.12 0.31"
"1.50 2.47 1.69 2.56 2.82 0.58"
"0.84 2.27 1.55 2.39 2.67 0.54"
"2.33 1.52 0.80 1.22 1.34 0.37"
"1.38 2.24 1.51 2.37 2.66 0.55"
"0.88 2.21 1.52 2.36 2.64 0.54"
"2.77 1.18 0.92 1.54 1.82 0.45"
"1.57 2.36 1.60 2.44 2.73 0.57"
"0.95 2.14 1.46 2.31 2.61 0.53"

)


# 2. Maps
racing_maps=("Spielberg" "hairpin_combo")
obs_map="playground"
opponent_csvs=(
    "bumper_slow_0.5.csv"
    "bumper_slow_1.csv"
    "bumper_slow_1.5.csv"
    "bumper_slow_2.csv"
    "bumper_v_2.csv"
    "bumper_v_3.csv"
    "bumper_v_4.csv"
    "bumper_v_5.csv"    
    
)

# [핵심] RViz를 켜고 싶으므로 true로 설정
USE_RVIZ="true"

# ==========================================
# [함수] 강력한 프로세스 정리 (RViz 포함)
# ==========================================

# 1. 가벼운 정리 (같은 맵에서 실험만 다시 할 때)
cleanup_run_nodes() {
    echo "   >>> [Partial Cleanup] Killing Controller & Loggers..."
    pkill -f "mux_auto_run.launch.py"
    pkill -f "mux_controller"
    pkill -f "planner_mux_node"
    pkill -f "pure_pursuit"
    pkill -f "racecar_frenet_cpp"
    pkill -f "fgm_node"
    pkill -f "f1tenth_planner"
    pkill -f "run_logger"
    pkill -f "avoid_logger"
    pkill -f "collision_monitor"
    pkill -f "static_path_publisher"
    # 주행 노드는 금방 죽으므로 짧게 대기
    sleep 2
}

# 2. 완전 박멸 (맵 바꿀 때 - RViz까지 확인 사살)
cleanup_all_nodes() {
    echo "   >>> [Full Cleanup] Killing EVERYTHING (Map, RViz, Sim)..."
    
    # 먼저 주행 노드 정리
    cleanup_run_nodes
    
    # 맵 & 시뮬레이터 & RViz 종료 명령
    pkill -f "mux_auto_map.launch.py"
    pkill -f "map_gym_bridge"
    pkill -f "map_server"
    pkill -f "gym_bridge"
    pkill -f "nav2_map_server"
    pkill -f "lifecycle_manager"
    pkill -f "nav2_lifecycle_manager"
    pkill -f "robot_state_publisher"
    pkill -f "nav2"
    
    # [핵심 1] RViz 종료 명령
    pkill -f "rviz2"

    # [핵심 2] Map Server가 죽을 때까지 대기
    echo "   >>> Waiting for map_server to die..."
    while pgrep -f "map_server" > /dev/null; do
        sleep 1
    done

    # [핵심 3] RViz가 죽을 때까지 대기 (가장 중요)
    echo "   >>> Waiting for RViz to close..."
    count=0
    while pgrep -f "rviz2" > /dev/null; do
        echo "       ... RViz is still running (wait 1s)"
        sleep 1
        count=$((count+1))
        # 10초 이상 안 꺼지면 강제 종료
        if [ $count -ge 10 ]; then
            echo "       !!! Force Killing RViz !!!"
            pkill -9 -f "rviz2"
            break
        fi
    done
    
    # [핵심 4] ROS 2 데몬 재시작 (통신 찌꺼기 제거)
    # 맵이 겹치는 현상은 DDS Discovery 캐시 문제일 수 있음
    echo "   >>> Resetting ROS 2 Daemon..."
    ros2 daemon stop > /dev/null 2>&1
    ros2 daemon start > /dev/null 2>&1
    
    echo "   >>> Cleanup Complete."
    sleep 5
}

# ==========================================
# [Phase 1] Racing Scenarios
# ==========================================
echo "=== Phase 1: Racing Scenarios ==="

cleanup_all_nodes

for map_name in "${racing_maps[@]}"; do
    
    if [ "$map_name" == "Spielberg" ]; then MAP_EXT=".png"; else MAP_EXT=".pgm"; fi

    echo "------------------------------------------------"
    echo ">>> [Map Setup] Starting Map: $map_name"
    
    # 맵 & RViz 실행 (백그라운드)
    ros2 launch racecar_experiments mux_auto_map.launch.py \
        map_name:=$map_name \
        map_img_ext:=$MAP_EXT \
        use_rviz:=$USE_RVIZ &
    
    # RViz가 켜지고 맵이 로드될 때까지 충분히 대기
    echo ">>> Waiting 15s for Map & RViz initialization..."
    sleep 15
    
    for params in "${mux_params[@]}"; do
        read -r ws wt wco wcl wd dm <<< "$params"
        echo ""
        echo "   >>> [Run] Weights: S=$ws T=$wt..."
        
        ros2 launch racecar_experiments mux_auto_run.launch.py \
            map_name:=$map_name \
            w_speed:=$ws w_track:=$wt w_comfort:=$wco w_clearance:=$wcl w_dynamics:=$wd d_min:=$dm
            
        echo "   >>> Run Finished. Cooldown..."
        
        # [Partial Cleanup] 지도는 끄지 않고 주행 노드만 끔
        cleanup_run_nodes
    done
    
    # 맵 다 썼으니 완전 종료 (RViz가 여기서 꺼짐)
    echo ">>> All runs for $map_name done."
    cleanup_all_nodes

done

# ==========================================
# [Phase 2] Obstacle Scenarios
# ==========================================
echo "=== Phase 2: Obstacle Scenarios ==="

cleanup_all_nodes

echo "------------------------------------------------"
echo ">>> [Map Setup] Starting Map: $obs_map"

ros2 launch racecar_experiments mux_auto_map.launch.py \
    map_name:=$obs_map \
    map_img_ext:=".pgm" \
    use_rviz:=$USE_RVIZ &

echo ">>> Waiting 15s for Map & RViz initialization..."
sleep 15

for opp_csv in "${opponent_csvs[@]}"; do
    echo ">>> Opponent: $opp_csv"
    for params in "${mux_params[@]}"; do
        read -r ws wt wco wcl wd dm <<< "$params"
        
        ros2 launch racecar_experiments mux_auto_run.launch.py \
            map_name:=$obs_map \
            opponent_csv_filename:=$opp_csv \
            w_speed:=$ws w_track:=$wt w_comfort:=$wco w_clearance:=$wcl w_dynamics:=$wd d_min:=$dm
            
        cleanup_run_nodes
    done
done

echo "=== All Experiments Completed ==="
cleanup_all_nodes